name: Build Wine

on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
      - master
  merge_group:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    # Skip build if PR was closed without merging
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.action != 'closed') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      github.event_name == 'merge_group' ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc \
            g++ \
            make \
            flex \
            bison \
            autoconf \
            automake \
            libtool \
            gettext \
            git \
            wget \
            curl \
            tar \
            xz-utils \
            patch \
            pkg-config \
            ccache \
            xorg-dev \
            libx11-dev \
            libxext-dev \
            libxrender-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libxfixes-dev \
            libxcursor-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxss-dev \
            libxtst-dev \
            libxrandr-dev \
            libasound2-dev \
            libpulse-dev \
            libdbus-1-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            liblcms2-dev \
            libxml2-dev \
            libxslt1-dev \
            libgnutls28-dev \
            libsane-dev \
            libv4l-dev \
            libgphoto2-dev \
            libcapi20-dev \
            libcups2-dev \
            libkrb5-dev \
            libldap2-dev \
            libsdl2-dev \
            libusb-1.0-0-dev \
            libudev-dev \
            libunwind-dev \
            libavcodec-dev \
            libavformat-dev \
            libavutil-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            samba-dev \
            ocl-icd-opencl-dev \
            opencl-headers

      - name: Set up ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=2G
          ccache --set-config=compression=true
          ccache -s

      - name: Verify OpenCL headers
        run: |
          if [ ! -f "/usr/include/CL/cl.h" ] && [ ! -f "/usr/local/include/CL/cl.h" ]; then
            echo "ERROR: OpenCL headers not found!"
            exit 1
          fi
          echo "✓ OpenCL headers found"

      - name: Set build environment variables
        run: |
          echo "BUILD_THREADS=$(nproc)" >> $GITHUB_ENV
          echo "CFLAGS=-O2 -std=gnu17 -pipe -ffat-lto-objects -Wno-discarded-qualifiers -Wno-format -Wno-maybe-uninitialized -Wno-misleading-indentation" >> $GITHUB_ENV
          echo "CROSSCFLAGS=-O2 -std=gnu17 -pipe -Wno-discarded-qualifiers -Wno-format -Wno-maybe-uninitialized -Wno-misleading-indentation" >> $GITHUB_ENV
          echo "CROSSCXXFLAGS=-O2 -std=gnu17 -pipe -Wno-discarded-qualifiers -Wno-format -Wno-maybe-uninitialized -Wno-misleading-indentation" >> $GITHUB_ENV
          echo "CROSSLDFLAGS=-Wl,-O1" >> $GITHUB_ENV
          echo "INSTALL_PREFIX=${{ github.workspace }}/wine-install" >> $GITHUB_ENV

      - name: Prepare build directory
        run: |
          # Verify configure script exists
          if [ ! -f "./configure" ]; then
            echo "❌ ERROR: configure script not found!"
            echo "This repository should contain a pre-configured Wine source."
            exit 1
          fi
          echo "✓ Configure script found"
          
          mkdir -p wine64-build
          mkdir -p ${{ env.INSTALL_PREFIX }}
          echo "✓ Build directories created"

      - name: Configure Wine (64-bit)
        working-directory: wine64-build
        env:
          CC: ccache gcc
          CXX: ccache g++
          CFLAGS: ${{ env.CFLAGS }}
          CROSSCFLAGS: ${{ env.CROSSCFLAGS }}
          CROSSCXXFLAGS: ${{ env.CROSSCXXFLAGS }}
          CROSSLDFLAGS: ${{ env.CROSSLDFLAGS }}
        run: |
          ../configure \
            --prefix="${{ env.INSTALL_PREFIX }}" \
            --enable-opencl \
            --enable-win64 \
            2>&1 | grep -v "configure: OSS sound system found but too old (OSSv4 needed)" || true
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "❌ ERROR: Wine configure failed!"
            exit 1
          fi
          echo "✓ Wine configure completed successfully"

      - name: Build Wine (64-bit)
        working-directory: wine64-build
        env:
          CC: ccache gcc
          CXX: ccache g++
          CFLAGS: ${{ env.CFLAGS }}
          CROSSCFLAGS: ${{ env.CROSSCFLAGS }}
          CROSSCXXFLAGS: ${{ env.CROSSCXXFLAGS }}
          CROSSLDFLAGS: ${{ env.CROSSLDFLAGS }}
        run: |
          echo "Building Wine with ${{ env.BUILD_THREADS }} threads..."
          make -j${{ env.BUILD_THREADS }} 2>&1 | tee wine-build.log || {
            echo "❌ ERROR: Wine build failed!"
            echo "Last 50 lines of build log:"
            tail -50 wine-build.log
            exit 1
          }
          
          # Filter out parser/sql warnings from output
          grep -Ev "(parser|sql)\.y: (warning|note):" wine-build.log || true
          echo "✓ Wine build completed successfully"
          echo ""
          echo "ccache statistics:"
          ccache -s
          
          # Ensure all programs are built (some might not be built by default in 64-bit only)
          echo ""
          echo "Building Wine programs..."
          make programs -j${{ env.BUILD_THREADS }} 2>&1 | tee -a wine-build.log || {
            echo "⚠ WARNING: Some programs may not have been built"
          }
          
          # Verify critical build artifacts exist (check multiple possible locations)
          echo "Checking for Wine executables..."
          if [ -f "programs/wine/wine" ]; then
            echo "✓ Found: programs/wine/wine"
          elif [ -f "programs/wine64/wine64" ]; then
            echo "✓ Found: programs/wine64/wine64"
          elif find programs -name "wine*" -type f -executable 2>/dev/null | head -1 | grep -q .; then
            echo "✓ Found Wine executable(s):"
            find programs -name "wine*" -type f -executable 2>/dev/null | head -5
          else
            echo "⚠ WARNING: Could not find Wine executables in expected locations"
            echo "Checking programs directory:"
            ls -la programs/*/ 2>/dev/null | head -20 || true
            echo "Build completed successfully, continuing with install..."
          fi

      - name: Install Wine
        working-directory: wine64-build
        env:
          CC: ccache gcc
          CXX: ccache g++
          CFLAGS: ${{ env.CFLAGS }}
          CROSSCFLAGS: ${{ env.CROSSCFLAGS }}
          CROSSCXXFLAGS: ${{ env.CROSSCXXFLAGS }}
          CROSSLDFLAGS: ${{ env.CROSSLDFLAGS }}
        run: |
          echo "Installing Wine..."
          # Initialize install log
          echo "=== Wine Installation Log ===" > wine-install.log
          
          # Verify win32u.so was built before attempting install
          if [ ! -f "dlls/win32u/win32u.so" ]; then
            echo "⚠ WARNING: win32u.so not found, checking if it needs to be built..."
            # Try to build just win32u if it's missing
            make dlls/win32u/win32u.so || echo "Could not build win32u.so"
          fi
          
          # For 64-bit only builds (--enable-win64), programs are NOT included in TOP_INSTALL_LIB
          # We need to install libs, dev files, and then explicitly install programs
          echo "Installing Wine libraries and DLLs..."
          make install-lib -j${{ env.BUILD_THREADS }} 2>&1 | tee -a wine-install.log || {
            echo "❌ ERROR: Failed to install Wine libraries"
            tail -50 wine-install.log
            exit 1
          }
          
          echo ""
          echo "Installing Wine development files (headers)..."
          make install-dev -j${{ env.BUILD_THREADS }} 2>&1 | tee -a wine-install.log || {
            echo "⚠ WARNING: make install-dev failed, but continuing..."
          }
          
          echo ""
          echo "Installing Wine programs and binaries..."
          # For 64-bit builds, programs must be installed explicitly
          # Install all programs from programs directory
          for progdir in programs/*/; do
            if [ -d "$progdir" ] && [ -f "$progdir/Makefile" ]; then
              echo "Installing $progdir..."
              make -C "$progdir" install 2>&1 | tee -a wine-install.log || {
                echo "⚠ WARNING: Failed to install $progdir"
              }
            fi
          done
          
          echo ""
          echo "Installing Wine tools (widl, winebuild, winegcc, etc.)..."
          # Install all tools from tools directory
          for tooldir in tools/wine tools/widl tools/winebuild tools/winedump tools/winegcc tools/winemaker tools/wmc tools/wrc; do
            if [ -d "$tooldir" ] && [ -f "$tooldir/Makefile" ]; then
              echo "Installing $tooldir..."
              make -C "$tooldir" install 2>&1 | tee -a wine-install.log || {
                echo "⚠ WARNING: Failed to install $tooldir"
              }
            fi
          done
          
          # Install wine program from loader (includes wine.inf)
          if [ -d "loader" ] && [ -f "loader/Makefile" ]; then
            echo "Installing loader/wine and wine.inf..."
            make -C loader install 2>&1 | tee -a wine-install.log || {
              echo "⚠ WARNING: Failed to install loader"
            }
          fi
          
          # Install wineserver
          if [ -d "server" ] && [ -f "server/Makefile" ]; then
            echo "Installing server/wineserver..."
            make -C server install 2>&1 | tee -a wine-install.log || {
              echo "⚠ WARNING: Failed to install server"
            }
          fi
          
          echo ""
          echo "Installing Wine fonts and NLS files..."
          # Install fonts
          if [ -d "fonts" ] && [ -f "fonts/Makefile" ]; then
            make -C fonts install 2>&1 | tee -a wine-install.log || echo "⚠ WARNING: Failed to install fonts"
          fi
          
          # Install NLS files
          if [ -d "nls" ] && [ -f "nls/Makefile" ]; then
            make -C nls install 2>&1 | tee -a wine-install.log || echo "⚠ WARNING: Failed to install nls"
          fi
          
          echo ""
          echo "✓ Wine installed successfully"

      - name: Verify installation
        run: |
          echo "Verifying installation at: ${{ env.INSTALL_PREFIX }}"
          
          # Check if install directory exists at all
          if [ ! -d "${{ env.INSTALL_PREFIX }}" ]; then
            echo "❌ ERROR: Installation directory not found at ${{ env.INSTALL_PREFIX }}"
            echo "Checking if it exists elsewhere:"
            find ${{ github.workspace }} -type d -name "wine-install" 2>/dev/null || echo "No wine-install directory found"
            echo ""
            echo "Checking what was created in the repository root:"
            ls -la ${{ github.workspace }} | head -20 || true
            exit 1
          fi
          
          echo "✓ Installation directory exists"
          echo "Installation directory contents:"
          ls -la "${{ env.INSTALL_PREFIX }}" || true
          echo ""
          
          # Verify all required directories exist (bin, include, lib, share)
          REQUIRED_DIRS=("bin" "include" "lib" "share")
          MISSING_DIRS=()
          
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ -d "${{ env.INSTALL_PREFIX }}/$dir" ]; then
              echo "✓ $dir/ directory found"
              echo "  Contents: $(ls -1 "${{ env.INSTALL_PREFIX }}/$dir" | wc -l) items"
            else
              echo "❌ $dir/ directory MISSING!"
              MISSING_DIRS+=("$dir")
            fi
          done
          
          if [ ${#MISSING_DIRS[@]} -gt 0 ]; then
            echo ""
            echo "❌ ERROR: Missing required directories: ${MISSING_DIRS[*]}"
            echo "Full directory structure:"
            find "${{ env.INSTALL_PREFIX }}" -maxdepth 2 -type d 2>/dev/null | sort
            exit 1
          fi
          
          echo ""
          echo "✓ All required directories verified (bin, include, lib, share)"
          echo ""
          echo "Directory sizes:"
          du -sh "${{ env.INSTALL_PREFIX }}"/* 2>/dev/null || true

      - name: Create tarball
        run: |
          echo "Creating tarball ElementalWarrior-wine-10.10.tar.xz..."
          cd ${{ github.workspace }}
          tar -cJf ElementalWarrior-wine-10.10.tar.xz -C wine-install .
          echo "✓ Tarball created successfully"
          ls -lh ElementalWarrior-wine-10.10.tar.xz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ElementalWarrior-wine-10.10
          path: ${{ github.workspace }}/ElementalWarrior-wine-10.10.tar.xz
          retention-days: 30

      - name: Build summary
        if: always()
        run: |
          echo "=========================================="
          if [ "${{ job.status }}" == "success" ]; then
            echo "✓ BUILD COMPLETE!"
          else
            echo "❌ BUILD FAILED!"
          fi
          echo "=========================================="
          echo ""
          echo "Artifact: ElementalWarrior-wine-10.10.tar.xz"
          echo "Installation prefix: ${{ env.INSTALL_PREFIX }}"
          echo ""


name: Build Wine

on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
      - master
  merge_group:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    # Skip build if PR was closed without merging
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.action != 'closed') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      github.event_name == 'merge_group' ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc \
            g++ \
            make \
            flex \
            bison \
            autoconf \
            automake \
            libtool \
            gettext \
            git \
            wget \
            curl \
            tar \
            xz-utils \
            patch \
            pkg-config \
            xorg-dev \
            libx11-dev \
            libxext-dev \
            libxrender-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libxfixes-dev \
            libxcursor-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxss-dev \
            libxtst-dev \
            libxrandr-dev \
            libasound2-dev \
            libpulse-dev \
            libdbus-1-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            liblcms2-dev \
            libxml2-dev \
            libxslt1-dev \
            libgnutls28-dev \
            libsane-dev \
            libv4l-dev \
            libgphoto2-dev \
            libcapi20-dev \
            libcups2-dev \
            libkrb5-dev \
            libldap2-dev \
            libsdl2-dev \
            libusb-1.0-0-dev \
            libudev-dev \
            libunwind-dev \
            libavcodec-dev \
            libavformat-dev \
            libavutil-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            samba-dev \
            ocl-icd-opencl-dev \
            opencl-headers

      - name: Verify OpenCL headers
        run: |
          if [ ! -f "/usr/include/CL/cl.h" ] && [ ! -f "/usr/local/include/CL/cl.h" ]; then
            echo "ERROR: OpenCL headers not found!"
            exit 1
          fi
          echo "✓ OpenCL headers found"

      - name: Set build environment variables
        run: |
          echo "BUILD_THREADS=$(nproc)" >> $GITHUB_ENV
          echo "CFLAGS=-O2 -std=gnu17 -pipe -ffat-lto-objects -Wno-discarded-qualifiers -Wno-format -Wno-maybe-uninitialized -Wno-misleading-indentation" >> $GITHUB_ENV
          echo "CROSSCFLAGS=-O2 -std=gnu17 -pipe -Wno-discarded-qualifiers -Wno-format -Wno-maybe-uninitialized -Wno-misleading-indentation" >> $GITHUB_ENV
          echo "CROSSCXXFLAGS=-O2 -std=gnu17 -pipe -Wno-discarded-qualifiers -Wno-format -Wno-maybe-uninitialized -Wno-misleading-indentation" >> $GITHUB_ENV
          echo "CROSSLDFLAGS=-Wl,-O1" >> $GITHUB_ENV
          echo "INSTALL_PREFIX=${{ github.workspace }}/wine-install" >> $GITHUB_ENV

      - name: Prepare build directory
        run: |
          # Verify configure script exists
          if [ ! -f "./configure" ]; then
            echo "❌ ERROR: configure script not found!"
            echo "This repository should contain a pre-configured Wine source."
            exit 1
          fi
          echo "✓ Configure script found"
          
          mkdir -p wine64-build
          mkdir -p ${{ env.INSTALL_PREFIX }}
          echo "✓ Build directories created"

      - name: Configure Wine (64-bit)
        working-directory: wine64-build
        env:
          CFLAGS: ${{ env.CFLAGS }}
          CROSSCFLAGS: ${{ env.CROSSCFLAGS }}
          CROSSCXXFLAGS: ${{ env.CROSSCXXFLAGS }}
          CROSSLDFLAGS: ${{ env.CROSSLDFLAGS }}
        run: |
          ../configure \
            --prefix="${{ env.INSTALL_PREFIX }}" \
            --enable-opencl \
            --enable-win64 \
            2>&1 | grep -v "configure: OSS sound system found but too old (OSSv4 needed)" || true
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "❌ ERROR: Wine configure failed!"
            exit 1
          fi
          echo "✓ Wine configure completed successfully"

      - name: Build Wine (64-bit)
        working-directory: wine64-build
        env:
          CFLAGS: ${{ env.CFLAGS }}
          CROSSCFLAGS: ${{ env.CROSSCFLAGS }}
          CROSSCXXFLAGS: ${{ env.CROSSCXXFLAGS }}
          CROSSLDFLAGS: ${{ env.CROSSLDFLAGS }}
        run: |
          echo "Building Wine with ${{ env.BUILD_THREADS }} threads..."
          make -j${{ env.BUILD_THREADS }} 2>&1 | tee wine-build.log || {
            echo "❌ ERROR: Wine build failed!"
            echo "Last 50 lines of build log:"
            tail -50 wine-build.log
            exit 1
          }
          
          # Filter out parser/sql warnings from output
          grep -Ev "(parser|sql)\.y: (warning|note):" wine-build.log || true
          echo "✓ Wine build completed successfully"
          
          # Verify critical build artifacts exist (check multiple possible locations)
          echo "Checking for Wine executables..."
          if [ -f "programs/wine/wine" ]; then
            echo "✓ Found: programs/wine/wine"
          elif [ -f "programs/wine64/wine64" ]; then
            echo "✓ Found: programs/wine64/wine64"
          elif find programs -name "wine*" -type f -executable 2>/dev/null | head -1 | grep -q .; then
            echo "✓ Found Wine executable(s):"
            find programs -name "wine*" -type f -executable 2>/dev/null | head -5
          else
            echo "⚠ WARNING: Could not find Wine executables in expected locations"
            echo "Checking programs directory:"
            ls -la programs/*/ 2>/dev/null | head -20 || true
            echo "Build completed successfully, continuing with install..."
          fi

      - name: Install Wine
        working-directory: wine64-build
        env:
          CFLAGS: ${{ env.CFLAGS }}
          CROSSCFLAGS: ${{ env.CROSSCFLAGS }}
          CROSSCXXFLAGS: ${{ env.CROSSCXXFLAGS }}
          CROSSLDFLAGS: ${{ env.CROSSLDFLAGS }}
        run: |
          echo "Installing Wine..."
          # Initialize install log
          echo "=== Wine Installation Log ===" > wine-install.log
          
          # Verify win32u.so was built before attempting install
          if [ ! -f "dlls/win32u/win32u.so" ]; then
            echo "⚠ WARNING: win32u.so not found, checking if it needs to be built..."
            # Try to build just win32u if it's missing
            make dlls/win32u/win32u.so || echo "Could not build win32u.so"
          fi
          
          # Use single-threaded install to avoid race conditions
          # For 64-bit only build, we need to install both lib and dev components
          echo "Installing Wine libraries and runtime..."
          make install-lib 2>&1 | tee -a wine-install.log || {
            echo "❌ ERROR: Failed to install Wine libraries"
            echo "Last 50 lines of install log:"
            tail -50 wine-install.log
            exit 1
          }
          
          echo ""
          echo "Installing Wine development files and binaries..."
          make install-dev 2>&1 | tee -a wine-install.log || {
            echo "❌ ERROR: Failed to install Wine development files"
            echo "Last 50 lines of install log:"
            tail -50 wine-install.log
            exit 1
          }
          
          # Check what was actually installed and fail if required directories are missing
          echo ""
          echo "Checking installed directories:"
          if [ ! -d "${{ env.INSTALL_PREFIX }}" ]; then
            echo "❌ ERROR: Install prefix directory not found at ${{ env.INSTALL_PREFIX }}"
            echo "Checking what was created:"
            ls -la .. | grep -E "(wine|install)" || true
            exit 1
          fi
          
          echo "Install prefix: ${{ env.INSTALL_PREFIX }}"
          ls -la "${{ env.INSTALL_PREFIX }}" || true
          echo ""
          
          # Verify all required directories exist, fail if any are missing
          MISSING_DIRS=()
          echo "Checking for required directories:"
          for dir in bin include lib share; do
            if [ -d "${{ env.INSTALL_PREFIX }}/$dir" ]; then
              file_count=$(find "${{ env.INSTALL_PREFIX }}/$dir" -type f 2>/dev/null | wc -l)
              echo "  ✓ $dir/ exists ($file_count files)"
              if [ "$file_count" -eq 0 ]; then
                echo "  ⚠ WARNING: $dir/ is empty!"
              fi
            else
              echo "  ❌ $dir/ MISSING!"
              MISSING_DIRS+=("$dir")
            fi
          done
          
          if [ ${#MISSING_DIRS[@]} -gt 0 ]; then
            echo ""
            echo "❌ ERROR: Missing required directories: ${MISSING_DIRS[*]}"
            echo "Install log summary:"
            grep -i "error\|fail\|missing" wine-install.log | tail -20 || true
            echo ""
            echo "Full directory structure:"
            find "${{ env.INSTALL_PREFIX }}" -maxdepth 2 -type d 2>/dev/null | sort
            exit 1
          fi
          
          echo ""
          echo "✓ Wine installed successfully - all required directories present"

      - name: Verify installation
        run: |
          echo "Verifying installation at: ${{ env.INSTALL_PREFIX }}"
          
          # Check if install directory exists at all
          if [ ! -d "${{ env.INSTALL_PREFIX }}" ]; then
            echo "❌ ERROR: Installation directory not found at ${{ env.INSTALL_PREFIX }}"
            echo "Checking if it exists elsewhere:"
            find ${{ github.workspace }} -type d -name "wine-install" 2>/dev/null || echo "No wine-install directory found"
            echo ""
            echo "Checking what was created in the repository root:"
            ls -la ${{ github.workspace }} | head -20 || true
            exit 1
          fi
          
          echo "✓ Installation directory exists"
          echo "Installation directory contents:"
          ls -la "${{ env.INSTALL_PREFIX }}" || true
          echo ""
          
          # Verify all required directories exist (bin, include, lib, share)
          REQUIRED_DIRS=("bin" "include" "lib" "share")
          MISSING_DIRS=()
          
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ -d "${{ env.INSTALL_PREFIX }}/$dir" ]; then
              echo "✓ $dir/ directory found"
              echo "  Contents: $(ls -1 "${{ env.INSTALL_PREFIX }}/$dir" | wc -l) items"
            else
              echo "❌ $dir/ directory MISSING!"
              MISSING_DIRS+=("$dir")
            fi
          done
          
          if [ ${#MISSING_DIRS[@]} -gt 0 ]; then
            echo ""
            echo "❌ ERROR: Missing required directories: ${MISSING_DIRS[*]}"
            echo "Full directory structure:"
            find "${{ env.INSTALL_PREFIX }}" -maxdepth 2 -type d 2>/dev/null | sort
            exit 1
          fi
          
          echo ""
          echo "✓ All required directories verified (bin, include, lib, share)"
          echo ""
          echo "Directory sizes:"
          du -sh "${{ env.INSTALL_PREFIX }}"/* 2>/dev/null || true

      - name: Create tarball
        run: |
          echo "Creating tarball ElementalWarrior-wine-10.10.tar.xz..."
          cd ${{ github.workspace }}
          
          # Verify all required directories exist before creating tarball
          echo "Verifying all required directories are present:"
          for dir in bin include lib share; do
            if [ ! -d "wine-install/$dir" ]; then
              echo "❌ ERROR: Required directory 'wine-install/$dir' is missing!"
              exit 1
            fi
            echo "✓ wine-install/$dir/ exists"
          done
          
          echo ""
          echo "Checking wine-install directory contents:"
          ls -la wine-install/ || { echo "❌ ERROR: wine-install directory not found!"; exit 1; }
          echo ""
          echo "Checking if directories have content:"
          for dir in bin include lib share; do
            if [ -d "wine-install/$dir" ]; then
              file_count=$(find "wine-install/$dir" -type f 2>/dev/null | wc -l)
              echo "  $dir/: $file_count files"
              if [ "$file_count" -eq 0 ]; then
                echo "  ⚠ WARNING: $dir/ is empty!"
              fi
            fi
          done
          echo ""
          
          # Verify wine-install has content before creating tarball
          total_files_in_install=$(find wine-install -type f 2>/dev/null | wc -l)
          if [ "$total_files_in_install" -eq 0 ]; then
            echo "❌ ERROR: wine-install directory is empty (no files found)!"
            echo "Directory structure:"
            find wine-install -type d 2>/dev/null | head -20 || true
            exit 1
          fi
          echo "Found $total_files_in_install files in wine-install, creating tarball..."
          
          echo "Creating tarball with all contents (bin, include, lib, share)..."
          # Remove any existing tarball first
          rm -f ElementalWarrior-wine-10.10.tar.xz
          
          # Create tarball and capture output
          tar_output=$(tar -cJf ElementalWarrior-wine-10.10.tar.xz -C wine-install . 2>&1)
          tar_exit=$?
          
          if [ $tar_exit -ne 0 ]; then
            echo "❌ ERROR: tar command failed (exit code: $tar_exit)!"
            echo "Tar output:"
            echo "$tar_output"
            echo ""
            echo "Checking wine-install directory:"
            ls -la wine-install/ || true
            exit 1
          fi
          
          # Check tarball was created and has content
          if [ ! -f "ElementalWarrior-wine-10.10.tar.xz" ]; then
            echo "❌ ERROR: Tarball file was not created!"
            exit 1
          fi
          
          tarball_size=$(stat -f%z ElementalWarrior-wine-10.10.tar.xz 2>/dev/null || stat -c%s ElementalWarrior-wine-10.10.tar.xz 2>/dev/null || echo "0")
          if [ "$tarball_size" -eq 0 ]; then
            echo "❌ ERROR: Tarball is 0 bytes (empty)!"
            echo "Checking wine-install directory:"
            ls -la wine-install/ || true
            echo ""
            echo "Checking wine-install contents:"
            find wine-install -type f 2>/dev/null | head -20 || echo "No files found"
            exit 1
          fi
          
          echo "✓ Tarball created successfully"
          ls -lh ElementalWarrior-wine-10.10.tar.xz
          echo ""
          echo "Tarball size: $(du -h ElementalWarrior-wine-10.10.tar.xz | cut -f1) ($tarball_size bytes)"
          echo "Tarball location: ${{ github.workspace }}/ElementalWarrior-wine-10.10.tar.xz"
          echo ""
          echo "Verifying tarball contents:"
          
          # Test if tarball can be read - disable exit on error temporarily
          set +e
          tar -tzf ElementalWarrior-wine-10.10.tar.xz > /tmp/tarball-contents.txt 2>/tmp/tar-errors.txt
          tar_exit=$?
          set -e
          
          if [ $tar_exit -ne 0 ]; then
            echo "⚠ WARNING: tar -tzf failed (exit code: $tar_exit), trying alternative method..."
            echo "Tar error output:"
            cat /tmp/tar-errors.txt 2>/dev/null || echo "(no error output)"
            
            # Try alternative: decompress first, then list
            set +e
            xz -dc ElementalWarrior-wine-10.10.tar.xz 2>/dev/null | tar -t > /tmp/tarball-contents.txt 2>/tmp/tar-errors2.txt
            alt_exit=$?
            set -e
            
            if [ $alt_exit -ne 0 ]; then
              echo "❌ ERROR: Both tar methods failed!"
              echo "Alternative method errors:"
              cat /tmp/tar-errors2.txt 2>/dev/null || echo "(no errors)"
              echo ""
              echo "Checking tarball file:"
              file ElementalWarrior-wine-10.10.tar.xz || true
              ls -lh ElementalWarrior-wine-10.10.tar.xz || true
              echo ""
              echo "Checking wine-install contents:"
              find wine-install -type f 2>/dev/null | head -20 || true
              exit 1
            else
              echo "✓ Alternative method succeeded"
            fi
          fi
          
          # Check if the output file has content
          if [ ! -s /tmp/tarball-contents.txt ]; then
            echo "❌ ERROR: Tarball listing is empty!"
            echo "Checking wine-install:"
            find wine-install -type f 2>/dev/null | head -20 || true
            exit 1
          fi
          
          total_files=$(wc -l < /tmp/tarball-contents.txt)
          echo "Total files in tarball: $total_files"
          
          if [ "$total_files" -eq 0 ]; then
            echo "❌ ERROR: Tarball is empty (no files listed)!"
            exit 1
          fi
          
          echo "Sample of tarball contents:"
          head -20 /tmp/tarball-contents.txt
          echo "..."
          
          echo ""
          echo "Checking for required directories in tarball:"
          MISSING_IN_TARBALL=()
          for dir in bin include lib share; do
            if grep -q "^$dir/" /tmp/tarball-contents.txt; then
              echo "✓ $dir/ found in tarball"
            else
              echo "❌ $dir/ NOT found in tarball!"
              MISSING_IN_TARBALL+=("$dir")
            fi
          done
          
          if [ ${#MISSING_IN_TARBALL[@]} -gt 0 ]; then
            echo ""
            echo "❌ ERROR: Missing directories in tarball: ${MISSING_IN_TARBALL[*]}"
            echo "Available directories in tarball:"
            cut -d'/' -f1 /tmp/tarball-contents.txt | sort -u | head -10
            exit 1
          fi
          
          echo "✓ All required directories (bin, include, lib, share) are in the tarball"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ElementalWarrior-wine-10.10
          path: ${{ github.workspace }}/ElementalWarrior-wine-10.10.tar.xz
          retention-days: 30

      - name: Build summary
        if: always()
        run: |
          echo "=========================================="
          if [ "${{ job.status }}" == "success" ]; then
            echo "✓ BUILD COMPLETE!"
          else
            echo "❌ BUILD FAILED!"
          fi
          echo "=========================================="
          echo ""
          echo "Artifact: ElementalWarrior-wine-10.10.tar.xz"
          echo "Installation prefix: ${{ env.INSTALL_PREFIX }}"
          echo ""

